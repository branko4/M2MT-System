services:
  mapping-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    depends_on:
      - database
    environment:
      PGUSER: mapping_system
      PGPASSWORD: hello
      PGHOST: database
    networks:
      - back-tier
      - data-tier
  proxy:
    build:
      context: Proxy
      dockerfile: Dockerfile
    depends_on:
      - mapping-backend
      - mapping-frontend
    environment:
      PROXY_MAPPING_API_PATH: "api/"
      PROXY_MAPPING_API_LOCATION: "http://mapping-backend:80/api/"
      PROXY_MAPPING_APP_LOCATION: "http://mapping-frontend/"
    networks:
      - back-tier
      - front-tier
    ports:
      - "80:80"
  mapping-frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    networks:
      - front-tier
  database:
    image: postgres:14.0
    networks:
      - data-tier
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: example
    volumes:
      - M2MT-test-database:/var/lib/postgresql/data
  backend-tester:
    build:
      context: .
      dockerfile: Dockerfile.newman
      args:
        TARGET: mapping-backend
    depends_on:
      - mapping-backend
    networks:
      - back-tier

networks:
  front-tier: {}
  back-tier: {}
  data-tier: {}

volumes:
  M2MT-test-database:
    external: true
